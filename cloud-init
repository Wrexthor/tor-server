#cloud-config
coreos:
  update:
    reboot-strategy: reboot

write_files:
  - path: /home/core/.toolboxrc
    owner: core
    content: |
      TOOLBOX_DOCKER_IMAGE=chriswayg/toolbox
  - path: /home/core/who.sh
    content: |
        #!/bin/bash
        set -x
        set -e
        whoami
  - path: /home/core/install-docker-compose
    content: |
        #!/bin/bash
        set -x
        set -e
        mkdir -pv /opt/bin
        curl -L https://github.com/docker/compose/releases/download/$(curl -Ls https://www.servercow.de/docker-compose/latest.php)/docker-compose-$(uname -s)-$(uname -m) > /opt/bin/docker-compose
        docker-compose --version
runcmd:
  - bash /root/who.sh
  - mkdir -pv /opt/bin
  - curl -L https://github.com/docker/compose/releases/download/$(curl -Ls https://www.servercow.de/docker-compose/latest.php)/docker-compose-$(uname -s)-$(uname -m) > /opt/bin/docker-compose
  - docker-compose --version
  - rm -v /etc/audit/rules.d/80-selinux.rules
  - rm -v /etc/audit/rules.d/99-default.rules
  - rm -v /etc/selinux/mcs
  - cp -v -a /usr/lib/selinux/mcs /etc/selinux
  - rm -v /var/lib/selinux
  - cp -v -a /usr/lib/selinux/policy /var/lib/selinux
  - semodule -DB
  - systemctl restart audit-rules
  - setenforce 1

journalctl -b _EXE=/usr/bin/coreos-cloudinit
